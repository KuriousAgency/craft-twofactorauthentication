{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Two-Factor Authentication"|t %}
{% set bodyClass = 'two-factor-authentication-settings' %}

{% includeCssResource "twofactorauthentication/css/verify.css" %}
{% includeJsResource "twofactorauthentication/js/verify.js" %}

{% set content %}

    <h2>{{ 'Why two-factor authentication?'|t }}</h2>
    <p>
        {{ 'With two-factor authentication you can improve protection of your account, because your phone (or other device) is needed as a second step during login.'|t }}<br />
        {{ 'When enabled, login has an extra required step: First you login as usual, second you need to enter a code generated by your personal device.'|t }}
    </p>

    <hr />

    {% if craft.twoFactorAuthentication.isUserVerified() %}

        <h2 class="success">{{ 'Your account is secured.'|t }}</h2>
        <p>{{ 'Two-factor authentication is enabled for your personal account.'|t }}</p>

        <hr />

        <h2>{{ 'Disable two-factor authentication'|t }}</h2>
        <p>{{ 'To disable two-factor authentication, click the button below.'|t }}</p>

        <form id="turnoff-form" action="{{ actionUrl('twoFactorAuthentication/settings/turnOff') }}" method="post" accept-charset="UTF-8">
            {{ getCsrfInput() }}

            <input id="submit" class="btn submit icon insecure" type="submit" value="{{- "I don't want two-factor authentication"|t -}}">
        </form>

    {% else %}

        <h2>{{ 'Step 1: Download app'|t }}</h2>
        <p>{{ 'Install a TOTP app like {linkOpen}Google Authenticator{linkClose} to set-up.'|t({
            linkOpen: '<a href="http://support.google.com/a/bin/answer.py?hl=en&answer=1037451" target="_blank">',
            linkClose: '</a>'
            })|raw }}
        </p>

        <hr />

        <h2>{{ 'Step 2: Setup your device with your personal secret'|t }}</h2>
        <p>{{ 'To turn on two-factor authentication for your personal account, please use either the secret code or the QR code.'|t }}</p>

        <table id="groups" class="data fullwidth collapsible">
            <thead>
                <th scope="col">{{ 'Your secret code:'|t }}</th>
                <th scope="col">{{ 'Your QR code:'|t }}</th>
            </thead>
            <tbody>
                <tr>
                    <td width="200">
                        {% set secret = craft.twoFactorAuthentication.getCurrentUserSecret() %}
                        <code>
                            {% for chunk in secret %}
                                <span>{{ chunk }}</span>
                            {% endfor %}
                        </code>
                        <p class="instructions">{{ 'Make sure to setup using time-based authentication.'|t }}</p>
                    </td>
                    <td>
                        <img src="{{ craft.twoFactorAuthentication.getCurrentUserQRCode()|raw }}" alt="" />
                    </td>
                </tr>
            </tbody>
        </table>

        <hr />

        <h2>{{ 'Step 3: Verify the code from your device'|t }}</h2>
        <p>{{ 'Please enter the code from your device, do note it changes every few seconds.'|t }}</p>

        <form id="verify-form" action="{{ actionUrl('twoFactorAuthentication/settings/turnOn') }}" method="post" accept-charset="UTF-8">
            {{ getCsrfInput() }}

            {{ forms.textField({ id: "authenticationCode", name: "code", placeholder: "Authentication Code"|t }) }}

            <div class="buttons">
                <input id="submit" class="btn submit disabled icon secure" type="submit" value="{{ "Verify"|t }}">
                <div id="spinner" class="spinner hidden"></div>
            </div>
        </form>

    {% endif %}
{% endset %}
